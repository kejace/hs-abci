<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>tutorial - </title> <link rel="shortcut icon" href="/hs-abci/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/hs-abci/assets/css/just-the-docs.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-5555555-55"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "UA-5555555-55"); </script> <script type="text/javascript" src="/hs-abci/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/hs-abci/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>tutorial</title> <meta name="generator" content="Jekyll v3.8.6" /> <meta property="og:title" content="tutorial" /> <meta property="og:locale" content="en_US" /> <script type="application/ld+json"> {"headline":"tutorial","@type":"WebPage","url":"/hs-abci/tutorial/Tutorial/Nameservice/Keeper.html","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="hs-abci" class="site-title lh-tight"> </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="/hs-abci/tutorial/Tutorial/Nameservice/Application.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Foundations/BaseApp.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item active"><a href="/hs-abci/tutorial/Tutorial/Nameservice/Keeper.html" class="navigation-list-link active">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Tutorial/Nameservice/Message.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Tutorial/Nameservice/Module.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Foundations/Modules.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Foundations/Overview.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Tutorial/Nameservice/Overview.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Tutorial/Nameservice/Query.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/README.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/Tutorial/Nameservice/Types.html" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item active"><a href="/hs-abci/" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="/hs-abci/tutorial/" class="navigation-list-link">tutorial</a></li><li class="navigation-list-item"><a href="/hs-abci/" class="navigation-list-link">hs-abci</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> <ul class="list-style-none text-small aux-nav"> <li class="d-inline-block my-0"><a href="//github.com/f-o-a-m/hs-abci">GitHub project</a></li> </ul> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h1 id="keeper"> <a href="#keeper" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Keeper </h1> <h2 id="definition"> <a href="#definition" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Definition </h2> <p>&quot;Keeper&quot; is a word taken from the cosmos-sdk, it's basically the interface that the module exposes to the other modules in the application. For example, in the Nameservice app, the Nameservice keeper exposes functions to <code>buy</code>/<code>sell</code>/<code>delete</code> entries in the mapping. Likewise, the Nameservice keeper depends on the keeper from the <code>bank</code> module in order to transfer tokens when executing those methods. A keeper might also indicate what kinds of exceptions are able to be caught and thrown from the module. For example, calling <code>transfer</code> while buying a <code>Name</code> might throw an <code>InsufficientFunds</code> exception, which the Namerservice module can chose whether to catch or not.</p> <h2 id="tutorial.nameservice.keeper"> <a href="#tutorial.nameservice.keeper" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Tutorial.Nameservice.Keeper </h2> <div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span>
<span class="kw">module</span> <span class="dt">Tutorial.Nameservice.Keeper</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Data.Proxy</span>
<span class="kw">import </span><span class="dt">Data.String.Conversions</span> (cs)
<span class="kw">import </span><span class="dt">GHC.TypeLits</span> (symbolVal)
<span class="kw">import </span><span class="dt">Polysemy</span> (<span class="dt">Sem</span>, <span class="dt">Members</span>, makeSem, interpret)
<span class="kw">import </span><span class="dt">Polysemy.Error</span> (<span class="dt">Error</span>, throw, mapError)
<span class="kw">import </span><span class="dt">Polysemy.Output</span> (<span class="dt">Output</span>)
<span class="kw">import </span><span class="dt">Nameservice.Modules.Nameservice.Messages</span> (<span class="dt">DeleteName</span>(..))
<span class="kw">import </span><span class="dt">Nameservice.Modules.Nameservice.Types</span> (<span class="dt">Whois</span>(..), <span class="dt">Name</span>, <span class="dt">NameDeleted</span>(..), <span class="dt">NameserviceModuleName</span>, <span class="dt">NameserviceError</span>(..))
<span class="kw">import </span><span class="dt">Nameservice.Modules.Token</span> (<span class="dt">Token</span>, mint)
<span class="kw">import qualified</span> <span class="dt">Tendermint.SDK.BaseApp</span> <span class="kw">as</span> <span class="dt">BA</span></code></pre></div> <p>Generally a keeper is defined by a set of effects that the module introduces and depends on. In the case of Nameservice, we introduce the custom <code>Nameservice</code> effect:</p> <div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">NameserviceKeeper</span> m a <span class="kw">where</span>
  <span class="dt">PutWhois</span><span class="ot"> ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Whois</span> <span class="ot">-&gt;</span> <span class="dt">NameserviceKeeper</span> m ()
  <span class="dt">GetWhois</span><span class="ot"> ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">NameserviceKeeper</span> m (<span class="dt">Maybe</span> <span class="dt">Whois</span>)
  <span class="dt">DeleteWhois</span><span class="ot"> ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">NameserviceKeeper</span> m ()

makeSem <span class="ch">&#39;&#39;</span><span class="dt">NameserviceKeeper</span>

<span class="kw">type</span> <span class="dt">NameserviceEffs</span> <span class="fu">=</span> <span class="ch">&#39;[NameserviceKeeper, Error NameserviceError]</span></code></pre></div> <p>where <code>makeSem</code> is from polysemy, it uses template Haskell to create the helper functions <code>putWhoIs</code>, <code>getWhois</code>, <code>deleteWhois</code>:</p> <div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">putWhois ::</span> forall r<span class="fu">.</span> <span class="dt">Member</span> <span class="dt">NameserviceKeeper</span> r <span class="ot">=&gt;</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Whois</span> <span class="ot">-&gt;</span> <span class="dt">Sem</span> r ()
<span class="ot">getWhois ::</span> forall r<span class="fu">.</span> <span class="dt">Member</span> <span class="dt">NameserviceKeeper</span> r <span class="ot">=&gt;</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Sem</span> r (<span class="dt">Maybe</span> <span class="dt">Whois</span>)
<span class="ot">deleteWhois ::</span> forall r<span class="fu">.</span> <span class="dt">Member</span> <span class="dt">NameserviceKeeper</span> r <span class="ot">=&gt;</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Sem</span> r ()</code></pre></div> <p>We can then write the top level function for example for deleting a name:</p> <div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">deleteName
<span class="ot">  ::</span> <span class="dt">Members</span> [<span class="dt">Token</span>, <span class="dt">Output</span> <span class="dt">BA.Event</span>] r
  <span class="ot">=&gt;</span> <span class="dt">Members</span> [<span class="dt">NameserviceKeeper</span>, <span class="dt">Error</span> <span class="dt">NameserviceError</span>] r
  <span class="ot">=&gt;</span> <span class="dt">DeleteName</span>
  <span class="ot">-&gt;</span> <span class="dt">Sem</span> r ()
deleteName <span class="dt">DeleteName</span>{<span class="fu">..</span>} <span class="fu">=</span> <span class="kw">do</span>
  mWhois <span class="ot">&lt;-</span> getWhois deleteNameName
  <span class="kw">case</span> mWhois <span class="kw">of</span>
    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throw <span class="fu">$</span> <span class="dt">InvalidDelete</span> <span class="st">&quot;Can&#39;t remove unassigned name.&quot;</span>
    <span class="dt">Just</span> <span class="dt">Whois</span>{<span class="fu">..</span>} <span class="ot">-&gt;</span>
      <span class="kw">if</span> whoisOwner <span class="fu">/=</span> deleteNameOwner
        <span class="kw">then</span> throw <span class="fu">$</span> <span class="dt">InvalidDelete</span> <span class="st">&quot;Deleter must be the owner.&quot;</span>
        <span class="kw">else</span> <span class="kw">do</span>
          mint deleteNameOwner whoisPrice
          deleteWhois deleteNameName
          BA.emit <span class="dt">NameDeleted</span>
            { nameDeletedName <span class="fu">=</span> deleteNameName
            }</code></pre></div> <p>The control flow should be pretty clear: 1. Check that the name is actually registered, if not throw an error. 2. Check that the name is registered to the person trying to delete it, if not throw an error. 3. Refund the tokens locked in the name to the owner. 4. Delete the entry from the database. 5. Emit an event that the name has been deleted.</p> <p>Taking a look at the class constraints, we see</p> <div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(<span class="dt">Members</span> <span class="dt">NameserviceEffs</span>, <span class="dt">Members</span> [<span class="dt">Token</span>, <span class="dt">Output</span> <span class="dt">Event</span>] r)</code></pre></div> <ul> <li>The <code>NameserviceKeeper</code> effect is required because the function may manipulate the modules database with <code>deleteName</code>.</li> <li>The <code>Error NameserviceError</code> effect is required because the function may throw an error.</li> <li>The <code>Token</code> effect is required because the function will mint coins.</li> <li>The <code>Output Event</code> effect is required because the function may emit a <code>NameDeleted</code> event.</li> </ul> <h3 id="evaluating-module-effects"> <a href="#evaluating-module-effects" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Evaluating Module Effects </h3> <p>Like we said before, all modules must ultimately compile to the set of effects belonging to <code>BaseApp</code>. For effects interpreted to <code>RawStore</code>, this means that you will need to define something called a <code>StoreKey</code>.</p> <p>A <code>StoreKey</code> is effectively a namespacing inside the database, and is unique for a given module. In theory it could be any <code>ByteString</code>, but the natural definition in the case of Nameservice is would be something like</p> <div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">storeKey ::</span> <span class="dt">BA.StoreKey</span> <span class="dt">NameserviceModuleName</span>
storeKey <span class="fu">=</span> <span class="dt">BA.StoreKey</span> <span class="fu">.</span> cs <span class="fu">.</span> symbolVal <span class="fu">$</span> (<span class="dt">Proxy</span> <span class="fu">@</span><span class="dt">NameserviceModuleName</span>)</code></pre></div> <p>With this <code>storeKey</code> it is possible to write the <code>eval</code> function to resolve the effects defined in Nameservice, namely the <code>NameserviceKeeper</code> effect and <code>Error NameserviceError</code>:</p> <div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">eval
<span class="ot">  ::</span> <span class="dt">Members</span> [<span class="dt">BA.RawStore</span>, <span class="dt">Error</span> <span class="dt">BA.AppError</span>] r
  <span class="ot">=&gt;</span> forall a<span class="fu">.</span> <span class="dt">Sem</span> (<span class="dt">NameserviceKeeper</span> <span class="ch">&#39;: Error NameserviceError &#39;</span><span class="fu">:</span> r) a
  <span class="ot">-&gt;</span> <span class="dt">Sem</span> r a
eval <span class="fu">=</span> mapError BA.makeAppError <span class="fu">.</span> evalNameservice
  <span class="kw">where</span>
    evalNameservice
<span class="ot">      ::</span> <span class="dt">Members</span> [<span class="dt">BA.RawStore</span>, <span class="dt">Error</span> <span class="dt">BA.AppError</span>] r
      <span class="ot">=&gt;</span> <span class="dt">Sem</span> (<span class="dt">NameserviceKeeper</span> <span class="ch">&#39;: r) a -&gt; Sem r a</span>
    evalNameservice <span class="fu">=</span>
      interpret (\<span class="kw">case</span>
          <span class="dt">GetWhois</span> name <span class="ot">-&gt;</span> BA.get storeKey name
          <span class="dt">PutWhois</span> name whois <span class="ot">-&gt;</span> BA.put storeKey name whois
          <span class="dt">DeleteWhois</span> name <span class="ot">-&gt;</span> BA.delete storeKey name
        )</code></pre></div> <p><a href="Query.md">Next: Query</a></p> </div> </div> </div> </div> </body> </html>
